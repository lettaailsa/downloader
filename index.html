<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>TikDownload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/jpeg" href="https://kiracloud.my.id/KC9K.jpeg" />
  <style>
    :root {
      --bg: #000;
      --card: #0a0a0a;
      --accent: #888;
      --accent2: #fff;
      --radius: 12px;
    }
    * { box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Roboto,Arial,sans-serif }
    body {
      background:var(--bg);
      color:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:20px;
    }
    h1 {
      font-size:2rem;
      font-weight:700;
      letter-spacing:1px;
      margin-bottom:25px;
      color:var(--accent2);
      text-transform:uppercase;
      text-align:center;
    }
    .selector { display:flex; gap:10px; justify-content:center; margin-bottom:25px; flex-wrap:wrap; }
    .selector button { padding:12px 20px; border:none; border-radius:var(--radius); background:linear-gradient(135deg,#222,#111); color:#fff; font-size:1rem; cursor:pointer; transition:.3s; }
    .selector button:hover { background:linear-gradient(135deg,#444,#222); transform:translateY(-2px); }
    .selector button.active { background:linear-gradient(135deg,#555,#333); box-shadow:0 0 10px rgba(255,255,255,0.2) }
    .card { background:var(--card); border-radius:var(--radius); padding:25px; width:100%; max-width:480px; text-align:center; box-shadow:0 0 25px rgba(255,255,255,0.08); display:none; animation:fadeIn 0.5s ease; }
    .card.active { display:block }
    .input-row { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    input[type=url] { flex:1; padding:12px 15px; border:none; border-radius:var(--radius); font-size:1rem; background:#111; color:#fff; outline:1px solid #333; transition:.3s; }
    input[type=url]:focus { outline:1px solid var(--accent); }
    .clip-btn { display:flex; align-items:center; justify-content:center; min-width:44px; height:44px; padding:6px 10px; border-radius:12px; background:linear-gradient(135deg,#222,#111); color:#fff; border:none; cursor:pointer; font-size:0.9rem; }
    .clip-btn:hover { background:linear-gradient(135deg,#444,#222); transform:translateY(-1px); }
    .clip-btn.hidden { display:none; }
    button.download { width:100%; padding:12px; background:linear-gradient(135deg,#333,#111); color:#fff; border:none; border-radius:var(--radius); font-size:1rem; cursor:pointer; transition:0.3s; }
    button.download:hover { background:linear-gradient(135deg,#555,#222); transform:translateY(-2px); }
    .loading { margin:15px 0; font-size:0.95rem; color:#aaa; display:none; }
    .result { display:none; margin-top:20px; background:#111; border-radius:var(--radius); padding:15px; box-shadow:inset 0 0 10px rgba(255,255,255,0.05); animation:fadeIn 0.5s ease; }
    .result img { width:100%; border-radius:var(--radius); margin-bottom:10px; }
    .dlbtn { display:block; margin:8px 0; padding:10px; background:#222; border-radius:var(--radius); text-align:center; color:#fff; cursor:pointer; text-decoration:none; border:none; width:100%; }
    .dlbtn:hover { background:#333; }
    footer { margin-top:30px; font-size:0.8rem; color:#777; text-align:center; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  </style>
</head>
<body>

  <h1>TikDownload</h1>

  <div class="selector">
    <button id="btnTT" onclick="selectTab('tt')">TikTok</button>
    <button id="btnIG" onclick="selectTab('ig')">Instagram</button>
    <button id="btnSP" onclick="selectTab('sp')">Spotify</button>
  </div>

  <!-- Instagram -->
  <div class="card" id="card-ig">
    <p style="color:#777;margin-bottom:10px;">Unduh foto & video dari Instagram</p>
    <div class="input-row">
      <input id="ig-url" type="url" placeholder="https://www.instagram.com/p/xxxxx">
      <button id="ig-paste" class="clip-btn">Paste</button>
      <button id="ig-clear" class="clip-btn hidden">Clear</button>
    </div>
    <button class="download" onclick="dlIG()">Download</button>
    <div class="loading" id="ig-load">⏳ Mengambil data...</div>
    <div class="result" id="ig-res"></div>
    <!-- DOWNLOAD MORE (IG) -->
    <button class="dlbtn" id="ig-more" style="display:none;margin-top:12px;" onclick="resetCard('ig')">Download More</button>
  </div>

  <!-- TikTok -->
  <div class="card" id="card-tt">
    <p style="color:#777;margin-bottom:10px;">Unduh video TikTok tanpa watermark</p>
    <div class="input-row">
      <input id="tt-url" type="url" placeholder="https://vt.tiktok.com/xxxxx">
      <button id="tt-paste" class="clip-btn">Paste</button>
      <button id="tt-clear" class="clip-btn hidden">Clear</button>
    </div>
    <button class="download" onclick="dlTT()">Download</button>
    <div class="loading" id="tt-load">⏳ Mengambil data...</div>
    <div class="result" id="tt-res">
      <img id="tt-thumb" alt="Thumbnail">
      <h4 id="tt-title"></h4>
      <button class="dlbtn" id="tt-hd">Download HD</button>
      <button class="dlbtn" id="tt-sd">Download SD</button>
      <button class="dlbtn" id="tt-mp3">Download Audio</button>
    </div>
    <!-- DOWNLOAD MORE (TT) -->
    <button class="dlbtn" id="tt-more" style="display:none;margin-top:12px;" onclick="resetCard('tt')">Download More</button>
  </div>

  <!-- Spotify -->
  <div class="card" id="card-sp">
    <p style="color:#777;margin-bottom:10px;">Unduh audio dari Spotify</p>
    <div class="input-row">
      <input id="sp-url" type="url" placeholder="https://open.spotify.com/track/...">
      <button id="sp-paste" class="clip-btn">Paste</button>
      <button id="sp-clear" class="clip-btn hidden">Clear</button>
    </div>
    <button class="download" onclick="dlSP()">Download</button>
    <div class="loading" id="sp-load">⏳ Mengambil data...</div>
    <div class="result" id="sp-res"></div>
    <!-- DOWNLOAD MORE (SP) -->
    <button class="dlbtn" id="sp-more" style="display:none;margin-top:12px;" onclick="resetCard('sp')">Download More</button>
  </div>

  <footer>© 2025 TikDownload</footer>

  <script>
    const buttons = {
      ig: document.getElementById('btnIG'),
      tt: document.getElementById('btnTT'),
      sp: document.getElementById('btnSP')
    };

    function selectTab(tab) {
      ['ig','tt','sp'].forEach(x => {
        document.getElementById('card-'+x).classList.remove('active');
        buttons[x].classList.remove('active');
      });
      document.getElementById('card-'+tab).classList.add('active');
      buttons[tab].classList.add('active');
    }
    selectTab('tt'); // default Instagram

    // ---------------------
    // CONFIG
    const proxyBase = '/proxy'; // contoh: 'http://localhost:3000/proxy' atau '' to disable

    // Utility + existing functions (kept as before)
    function rand6() {
      return Math.floor(100000 + Math.random() * 900000);
    }

    function inferExtension(url, contentType) {
      try {
        const u = new URL(url);
        const path = u.pathname;
        const match = path.match(/\.([a-z0-9]{2,5})(?:$|\?)/i);
        if (match) return match[1].toLowerCase();
      } catch(e){}
      if (contentType) {
        const ct = contentType.toLowerCase();
        if (ct.includes('mp4')) return 'mp4';
        if (ct.includes('mpeg') || ct.includes('audio/mpeg')) return 'mp3';
        if (ct.includes('webm')) return 'webm';
        if (ct.includes('png')) return 'png';
        if (ct.includes('jpeg') || ct.includes('jpg')) return 'jpg';
        if (ct.includes('gif')) return 'gif';
      }
      return 'bin';
    }

    function buildFilename(type, resolution, url, contentType) {
      const rnd = rand6();
      const ext = inferExtension(url, contentType);
      let suffix = '';
      if (type?.toLowerCase() === 'mp3') {
        suffix = '';
      } else if (resolution && resolution.trim() !== '') {
        const r = resolution.trim().toLowerCase();
        if (r === 'hd' || r === 'sd') {
          suffix = `-${r.toUpperCase()}`;
        } else {
          suffix = `-${r}`;
        }
      }
      return `TikDownload.live_${rnd}${suffix}.${ext}`;
    }

    // Spotify filename helper (kept)
    function sanitizeForFilename(s) {
      if (!s) return '';
      return s.toString()
        .replace(/[/\\?%*:|"<>]/g, '')
        .replace(/\s+/g, ' ')
        .trim()
        .substring(0, 120);
    }

    function buildSpotifyFilename(title, artists, urlOrDownloadLink, contentType) {
      const t = sanitizeForFilename(title || 'Unknown');
      const a = sanitizeForFilename(artists || 'Unknown');
      const ext = inferExtension(urlOrDownloadLink || '', contentType || 'audio/mpeg');
      const base = `TikDownload.live_${t}${a ? ' - ' + a : ''}`;
      return `${base}.${ext}`;
    }

    function downloadViaProxy(fileUrl, suggestedFilename) {
      if (!proxyBase) {
        return false;
      }
      try {
        const params = new URLSearchParams({ url: fileUrl, filename: suggestedFilename });
        const proxyUrl = `${proxyBase}?${params.toString()}`;
        const a = document.createElement('a');
        a.href = proxyUrl;
        document.body.appendChild(a);
        a.click();
        a.remove();
        return true;
      } catch (e) {
        console.error('downloadViaProxy error', e);
        return false;
      }
    }

    async function fetchAndSave(fileUrl, suggestedFilename) {
      try {
        const res = await fetch(fileUrl);
        if (!res.ok) throw new Error('Upstream not ok: ' + res.status);
        const contentType = res.headers.get('Content-Type') || '';
        const blob = await res.blob();
        const ext = inferExtension(fileUrl, contentType);
        const filename = suggestedFilename || `TikDownload.live_${rand6()}.${ext}`;
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(blobUrl), 10000);
        return true;
      } catch (err) {
        console.warn('fetchAndSave failed', err);
        return false;
      }
    }

    function fallbackOpen(fileUrl) {
      try {
        window.open(fileUrl, '_blank');
        alert('Tidak bisa mendownload langsung (CORS). Halaman file dibuka di tab baru — simpan manual. Untuk nama file sesuai template, jalankan proxy dan set proxyBase.');
      } catch (e) {
        alert('Gagal membuka file langsung. ' + (e && e.message ? e.message : ''));
      }
    }

    async function handleDownload(fileUrl, suggestedFilename) {
      if (!fileUrl) return false;
      if (proxyBase) {
        const ok = downloadViaProxy(fileUrl, suggestedFilename);
        if (ok) return true;
      }
      const okFetch = await fetchAndSave(fileUrl, suggestedFilename);
      if (okFetch) return true;
      fallbackOpen(fileUrl);
      return false;
    }

    function isImageUrl(url) {
      if (!url) return false;
      try {
        const path = (new URL(url)).pathname;
        const m = path.match(/\.([a-z0-9]{2,5})$/i);
        if (m && ['jpg','jpeg','png','webp','gif','bmp','heic','heif'].includes(m[1].toLowerCase())) return true;
      } catch(e){}
      return /(^data:image\/)|image\//i.test(url);
    }

    // Make download button — after download completes, show Download More for the card
    function makeDownloadButton(url, label, suggestedName) {
      const btn = document.createElement('button');
      btn.className = 'dlbtn';
      btn.textContent = label || 'Download';
      btn.addEventListener('click', async () => {
        await handleDownload(url, suggestedName);
        const card = btn.closest('.card');
        if (card && card.id === 'card-ig') {
          const igMore = document.getElementById('ig-more');
          if (igMore) igMore.style.display = 'block';
        } else if (card && card.id === 'card-tt') {
          const ttMore = document.getElementById('tt-more');
          if (ttMore) ttMore.style.display = 'block';
        } else if (card && card.id === 'card-sp') {
          const spMore = document.getElementById('sp-more');
          if (spMore) spMore.style.display = 'block';
        }
      });
      return btn;
    }

    async function batchDownload(items) {
      if (!items || !items.length) return alert('Tidak ada file untuk didownload.');
      const proceed = confirm(`Mulai mendownload ${items.length} file satu per satu? Pastikan proxy aktif jika perlu.`);
      if (!proceed) return;
      for (let i = 0; i < items.length; i++) {
        const it = items[i];
        try {
          const suggested = buildFilename(it.type || 'ig', it.resolution || '', it.url, it.contentType || '');
          const ok = await fetchAndSave(it.url, suggested);
          if (!ok) {
            await handleDownload(it.url, suggested);
          }
          await new Promise(r => setTimeout(r, 400));
        } catch (e) {
          console.error('batchDownload item error', e);
        }
      }
      alert('Proses batch download selesai.');
    }

    // Reset card to initial (without reload)
    function resetCard(tab) {
      if (tab === 'ig') {
        document.getElementById('ig-url').value = '';
        const resEl = document.getElementById('ig-res');
        resEl.innerHTML = '';
        resEl.style.display = 'none';
        document.getElementById('ig-load').style.display = 'none';
        document.getElementById('ig-more').style.display = 'none';
        // update paste/clear UI
        updatePasteClearState('ig');
      } else if (tab === 'tt') {
        document.getElementById('tt-url').value = '';
        const resEl = document.getElementById('tt-res');
        resEl.innerHTML = `
          <img id="tt-thumb" alt="Thumbnail">
          <h4 id="tt-title"></h4>
          <button class="dlbtn" id="tt-hd" style="display:none">Download HD</button>
          <button class="dlbtn" id="tt-sd" style="display:none">Download SD</button>
          <button class="dlbtn" id="tt-mp3" style="display:none">Download Audio</button>
        `;
        resEl.style.display = 'none';
        document.getElementById('tt-load').style.display = 'none';
        document.getElementById('tt-more').style.display = 'none';
        updatePasteClearState('tt');
      } else if (tab === 'sp') {
        document.getElementById('sp-url').value = '';
        const resEl = document.getElementById('sp-res');
        resEl.innerHTML = '';
        resEl.style.display = 'none';
        document.getElementById('sp-load').style.display = 'none';
        document.getElementById('sp-more').style.display = 'none';
        updatePasteClearState('sp');
      }
    }

    // --- Instagram downloader ---
    async function dlIG() {
      const url = document.getElementById('ig-url').value.trim();
      const load = document.getElementById('ig-load');
      const resEl = document.getElementById('ig-res');
      const maxInput = document.getElementById('ig-max');
      const downloadAllBtn = document.getElementById('ig-download-all');

      if (!url) return alert('Masukkan link Instagram!');
      resEl.innerHTML = '';
      load.style.display = 'block';
      if (downloadAllBtn) downloadAllBtn.style.display = 'none';
      try {
        const api = `https://api.nvidiabotz.xyz/download/instagram?url=${encodeURIComponent(url)}`;
        const res = await fetch(api);
        const json = await res.json();
        if (!json.status || !json.result?.length) throw new Error('Tidak ada media ditemukan');

        // flatten/normalize items
        const items = [];
        json.result.forEach(entry => {
          if (Array.isArray(entry.media)) {
            entry.media.forEach(m => items.push(m));
          } else if (Array.isArray(entry.files)) {
            entry.files.forEach(m => items.push(m));
          } else {
            const candidateUrl = entry.url_download || entry.url || entry.file || entry.src || entry.video || null;
            const thumb = entry.thumbnail || entry.preview || entry.thumb || null;
            const contentType = entry.contentType || '';
            const typeGuess = isImageUrl(candidateUrl) ? 'image' : 'media';
            const resolution = (/hd/i.test(candidateUrl) || /hd/i.test(entry.title || '')) ? 'hd' : '';
            const caption = entry.title || entry.caption || '';
            items.push({
              url: candidateUrl,
              thumbnail: thumb,
              contentType,
              type: typeGuess,
              resolution,
              caption
            });
          }
        });

        const max = Math.max(1, Math.min(100, Number(maxInput?.value || 10)));
        const limited = items.filter(it => it.url).slice(0, max);

        resEl.innerHTML = '';
        const batchForDownload = [];

        limited.forEach((item, idx) => {
          const container = document.createElement('div');
          container.style.marginBottom = '15px';
          container.style.textAlign = 'left';

          const thumbUrl = item.thumbnail || (isImageUrl(item.url) ? item.url : '');
          if (thumbUrl) {
            const img = document.createElement('img');
            img.src = thumbUrl;
            img.style.width = '100%';
            img.style.borderRadius = '10px';
            img.style.marginBottom = '6px';
            container.appendChild(img);
          }

          const lbl = document.createElement('div');
          lbl.style.color = '#ddd';
          lbl.style.fontSize = '0.9rem';
          lbl.style.marginBottom = '6px';
          // show caption from instagram if available (empty if none)
          lbl.textContent = item.caption || '';
          container.appendChild(lbl);

          // ===== DETEKSI IMAGE / VIDEO =====
          const urlStr = (item.url || '').toString();
          const ct = (item.contentType || '').toString().toLowerCase();
          const typeField = (item.type || '').toString().toLowerCase();

          const looksLikeImage = isImageUrl(urlStr);
          const looksLikeVideo = /\.(mp4|webm|mov|m4v|m3u8)(?:$|\?)/i.test(urlStr) || /video/.test(ct) || /video/.test(typeField);

          const isImage = looksLikeImage || typeField === 'image';
          const isVideo = !isImage && looksLikeVideo;

          const thumbLooksImage = isImageUrl(thumbUrl || '');
          let finalIsImage = isImage;
          let finalIsVideo = isVideo;
          if (!finalIsImage && !finalIsVideo) {
            if (thumbLooksImage) finalIsImage = true;
            else if (looksLikeVideo) finalIsVideo = true;
            else finalIsImage = true;
          }
          // ===== end detection =====

          const guessedType = finalIsImage ? 'image' : 'video';
          const guessedRes = item.resolution || ((finalIsImage && /hd/i.test(item.url)) ? 'hd' : '');
          const suggestedName = buildFilename(guessedType, guessedRes, item.url, item.contentType || '');

          // tombol tetap 'Download' sesuai permintaan
          const btnLabel = 'Download';
          const btn = makeDownloadButton(item.url, btnLabel, suggestedName);
          container.appendChild(btn);

          batchForDownload.push({
            url: item.url,
            contentType: item.contentType || '',
            type: guessedType,
            resolution: guessedRes
          });

          resEl.appendChild(container);
        });

        // show Download More as soon as results are displayed (so user can quickly "download more")
        const igMore = document.getElementById('ig-more');
        if (igMore && limited.length > 0) igMore.style.display = 'block';

        if (batchForDownload.length > 0) {
          if (downloadAllBtn) {
            downloadAllBtn.style.display = 'inline-block';
            downloadAllBtn.onclick = () => batchDownload(batchForDownload);
          }
        } else {
          if (downloadAllBtn) downloadAllBtn.style.display = 'none';
        }

        resEl.style.display = 'block';
      } catch(e) {
        console.error(e);
        alert(e.message || 'Server error');
      } finally {
        load.style.display = 'none';
      }
    }

    // --- TikTok downloader ---
    async function dlTT() {
      const url = document.getElementById('tt-url').value.trim();
      const load = document.getElementById('tt-load');
      const result = document.getElementById('tt-res');
      if (!url) return alert('Masukkan link TikTok!');
      load.style.display = 'block';
      result.style.display = 'none';
      try {
        const api = `https://api.nvidiabotz.xyz/download/tiktok?url=${encodeURIComponent(url)}`;
        const res = await fetch(api);
        const json = await res.json();
        if (!json.status) throw new Error(json.message || 'Gagal');

        const { video_hd, video_sd, mp3, thumbnail, title } = json.result;
        const resEl = document.getElementById('tt-res');
        resEl.style.display = 'block';
        const thumbEl = document.getElementById('tt-thumb');
        const titleEl = document.getElementById('tt-title');

        if (thumbEl) thumbEl.src = thumbnail || '';
        if (titleEl) titleEl.textContent = title || '';

        // HD
        const elHD = document.getElementById('tt-hd');
        if (video_hd) {
          if (elHD) {
            elHD.style.display = 'block';
            elHD.onclick = async () => {
              await handleDownload(video_hd, buildFilename('tt','hd',video_hd));
              const ttMore = document.getElementById('tt-more');
              if (ttMore) ttMore.style.display = 'block';
            };
          }
        } else {
          if (elHD) { elHD.style.display = 'none'; elHD.onclick = null; }
        }

        // SD
        const elSD = document.getElementById('tt-sd');
        if (video_sd) {
          if (elSD) {
            elSD.style.display = 'block';
            elSD.onclick = async () => {
              await handleDownload(video_sd, buildFilename('tt','sd',video_sd));
              const ttMore = document.getElementById('tt-more');
              if (ttMore) ttMore.style.display = 'block';
            };
          }
        } else {
          if (elSD) { elSD.style.display = 'none'; elSD.onclick = null; }
        }

        // MP3
        const elMP3 = document.getElementById('tt-mp3');
        if (mp3) {
          if (elMP3) {
            elMP3.style.display = 'block';
            elMP3.onclick = async () => {
              await handleDownload(mp3, buildFilename('mp3','',mp3));
              const ttMore = document.getElementById('tt-more');
              if (ttMore) ttMore.style.display = 'block';
            };
          }
        } else {
          if (elMP3) { elMP3.style.display = 'none'; elMP3.onclick = null; }
        }

        // If API returns images array for slideshow, render similarly to IG
        if (Array.isArray(json.result.images) && json.result.images.length) {
          result.innerHTML = '';
          const max = 100;
          // caption for slideshow (use title/caption from API if present)
          const slideCaption = (json.result.title || json.result.caption || '').toString();
          json.result.images.slice(0, max).forEach((imgUrl, idx) => {
            const div = document.createElement('div');
            div.style.marginBottom = '12px';

            const im = document.createElement('img');
            im.src = imgUrl;
            im.style.width = '100%';
            im.style.borderRadius = '10px';
            div.appendChild(im);

            // caption from TikTok (if any)
            if (slideCaption) {
              const capEl = document.createElement('div');
              capEl.style.color = '#ddd';
              capEl.style.fontSize = '0.95rem';
              capEl.style.marginTop = '6px';
              capEl.style.marginBottom = '6px';
              capEl.style.textAlign = 'center';
              capEl.textContent = slideCaption;
              div.appendChild(capEl);
            }

            const suggested = buildFilename('tt', '', imgUrl);
            const btn = makeDownloadButton(imgUrl, `Download`, suggested);
            div.appendChild(btn);
            result.appendChild(div);
          });
        }

        // show Download More as soon as result shown (if there's something)
        const ttMore = document.getElementById('tt-more');
        if (ttMore) ttMore.style.display = 'block';

        result.style.display = 'block';
      } catch(e) {
        console.error(e);
        alert(e.message || 'Server error');
      } finally {
        load.style.display = 'none';
      }
    }

    // --- Spotify downloader ---
    async function dlSP() {
      const url = document.getElementById('sp-url').value.trim();
      const load = document.getElementById('sp-load');
      const resEl = document.getElementById('sp-res');

      if (!url) return alert('Masukkan link Spotify!');
      resEl.innerHTML = '';
      load.style.display = 'block';
      try {
        const apiEndpoint = `https://api.vreden.my.id/api/v1/download/spotify?url=${encodeURIComponent(url)}`;
        const fetchUrl = proxyBase ? `${proxyBase}?url=${encodeURIComponent(apiEndpoint)}` : apiEndpoint;

        const r = await fetch(fetchUrl);
        const json = await r.json();
        if (!json || !json.status || !json.result) throw new Error('Tidak ada data Spotify');

        const res = json.result; // { id, title, artists, album, cover_url, duration_ms, download, ... }

        // build UI: cover, centered bold title — artist, download button
        const container = document.createElement('div');
        container.style.textAlign = 'left';
        container.style.marginBottom = '12px';

        if (res.cover_url) {
          const img = document.createElement('img');
          img.src = res.cover_url;
          img.style.width = '100%';
          img.style.borderRadius = '10px';
          img.style.marginBottom = '8px';
          container.appendChild(img);
        }

        // meta: center + bold + style like TikTok
        const meta = document.createElement('div');
        meta.style.color = '#fff';
        meta.style.fontWeight = 'bold';
        meta.style.textAlign = 'center';
        meta.style.fontSize = '1.05rem';
        meta.style.marginTop = '10px';
        meta.style.marginBottom = '12px';
        meta.textContent = (res.title ? res.title : '') + (res.artists ? (res.title ? ' — ' : '') + res.artists : '');
        if (meta.textContent) container.appendChild(meta);

        // download button (mp3 link)
        if (res.download) {
          // build Spotify-specific suggested filename: TikDownload.live_Judul - NamaArtis.ext
          const suggested = buildSpotifyFilename(res.title, res.artists, res.download);
          const btn = makeDownloadButton(res.download, 'Download', suggested);
          container.appendChild(btn);
        } else {
          const info = document.createElement('div');
          info.style.color = '#ddd';
          info.style.fontSize = '0.95rem';
          info.style.textAlign = 'center';
          info.textContent = 'Link download tidak tersedia';
          container.appendChild(info);
        }

        resEl.appendChild(container);

        // show Download More immediately
        const spMore = document.getElementById('sp-more');
        if (spMore) spMore.style.display = 'block';

        resEl.style.display = 'block';
      } catch (e) {
        console.error(e);
        alert(e.message || 'Server error');
      } finally {
        load.style.display = 'none';
      }
    }

    // ---------------------------
    // NEW: clipboard / paste / clear logic for each input
    // ---------------------------

    function attachClipboardHandlers(prefix) {
      const input = document.getElementById(`${prefix}-url`);
      const pasteBtn = document.getElementById(`${prefix}-paste`);
      const clearBtn = document.getElementById(`${prefix}-clear`);
      if (!input || !pasteBtn || !clearBtn) return;

      function updateButtonStates() {
        if (input.value.trim()) {
          pasteBtn.classList.add('hidden');
          clearBtn.classList.remove('hidden');
        } else {
          pasteBtn.classList.remove('hidden');
          clearBtn.classList.add('hidden');
        }
      }

      pasteBtn.addEventListener('click', () => {
        if (!navigator.clipboard || !navigator.clipboard.readText) {
          console.error('Clipboard API not available');
          return;
        }
        navigator.clipboard.readText().then(text => {
          if (text && text.trim()) {
            input.value = text.trim();
            updateButtonStates();
          }
        }).catch(err => {
          console.error('Unable to read clipboard content.', err);
        });
      });

      clearBtn.addEventListener('click', () => {
        input.value = '';
        updateButtonStates();
      });

      input.addEventListener('input', () => {
        updateButtonStates();
      });

      // initial state
      updateButtonStates();
    }

    // init clipboard handlers after DOM loaded
    document.addEventListener('DOMContentLoaded', function () {
      ['ig','tt','sp'].forEach(attachClipboardHandlers);
    });

    // helper to update state externally (used by resetCard)
    function updatePasteClearState(prefix) {
      const input = document.getElementById(`${prefix}-url`);
      const pasteBtn = document.getElementById(`${prefix}-paste`);
      const clearBtn = document.getElementById(`${prefix}-clear`);
      if (!input || !pasteBtn || !clearBtn) return;
      if (input.value.trim()) {
        pasteBtn.classList.add('hidden');
        clearBtn.classList.remove('hidden');
      } else {
        pasteBtn.classList.remove('hidden');
        clearBtn.classList.add('hidden');
      }
    }
  </script>
</body>
</html>
